<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ú–æ—Ä—Å–∫–æ–π –±–æ–π - –ú—É–ª—å—Ç–∏–ø–ª–µ–µ—Ä</title>
    
    <!-- PWA Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="–ú–æ—Ä—Å–∫–æ–π –±–æ–π">
    <meta name="theme-color" content="#1e3c72">
    <meta name="description" content="–ú–æ—Ä—Å–∫–æ–π –±–æ–π –¥–ª—è iPhone —Å –º—É–ª—å—Ç–∏–ø–ª–µ–µ—Ä–æ–º –ø–æ –ª–æ–∫–∞–ª—å–Ω–æ–π —Å–µ—Ç–∏">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1e3c72, #2a5298);
            color: white;
            min-height: 100vh;
            padding: 20px;
            touch-action: manipulation;
            -webkit-user-select: none;
            user-select: none;
        }
        
        .container {
            max-width: 600px;
            margin: 0 auto;
        }
        
        h1 {
            text-align: center;
            margin-bottom: 20px;
            font-size: 28px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }
        
        .screen {
            display: none;
        }
        
        .screen.active {
            display: block;
        }
        
        .game-info {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
            backdrop-filter: blur(10px);
        }
        
        .boards-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .board-section {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 10px;
            backdrop-filter: blur(10px);
        }
        
        .board-title {
            text-align: center;
            margin-bottom: 10px;
            font-weight: bold;
        }
        
        .board {
            display: grid;
            grid-template-columns: repeat(10, 1fr);
            grid-template-rows: repeat(10, 1fr);
            gap: 2px;
            width: 100%;
            aspect-ratio: 1;
            margin: 0 auto;
            background: rgba(255,255,255,0.1);
            padding: 5px;
            border-radius: 5px;
        }
        
        .cell {
            background: rgba(255,255,255,0.2);
            border-radius: 2px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
            -webkit-tap-highlight-color: transparent;
        }
        
        .cell:active {
            transform: scale(0.95);
        }
        
        .cell.ship {
            background: #4a90e2;
        }
        
        .cell.hit {
            background: #e74c3c;
            animation: hitAnimation 0.3s ease-in-out;
        }
        
        .cell.miss {
            background: #7f8c8d;
        }
        
        .cell.hit::after {
            content: "üí•";
            font-size: 14px;
        }
        
        .cell.miss::after {
            content: "‚Ä¢";
            color: white;
            font-size: 16px;
        }
        
        button {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 10px;
            background: #3498db;
            color: white;
            font-size: 16px;
            cursor: pointer;
            margin: 8px 0;
            font-weight: bold;
            transition: all 0.3s;
        }
        
        button:active {
            transform: scale(0.98);
            background: #2980b9;
        }
        
        button:disabled {
            background: #7f8c8d;
            cursor: not-allowed;
        }
        
        input {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 10px;
            margin: 8px 0;
            font-size: 16px;
            background: rgba(255,255,255,0.9);
        }
        
        .connection-status {
            padding: 12px;
            border-radius: 8px;
            margin: 10px 0;
            text-align: center;
            font-weight: bold;
        }
        
        .connected {
            background: rgba(46, 204, 113, 0.3);
            border: 2px solid #2ecc71;
        }
        
        .disconnected {
            background: rgba(231, 76, 60, 0.3);
            border: 2px solid #e74c3c;
        }
        
        .player-list {
            margin: 20px 0;
        }
        
        .player-item {
            background: rgba(255,255,255,0.15);
            padding: 15px;
            margin: 10px 0;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
        }
        
        .player-item:active {
            background: rgba(255,255,255,0.25);
            border-color: #3498db;
        }
        
        .ship-counter {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
            font-size: 14px;
        }
        
        .status-message {
            text-align: center;
            margin: 15px 0;
            font-size: 18px;
            font-weight: bold;
            min-height: 27px;
        }
        
        .qr-code {
            text-align: center;
            margin: 20px 0;
            padding: 15px;
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
        }
        
        .instructions {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            font-size: 14px;
        }
        
        @keyframes hitAnimation {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }
        
        @media (max-width: 480px) {
            body {
                padding: 15px;
            }
            
            h1 {
                font-size: 24px;
            }
            
            .cell {
                font-size: 10px;
            }
            
            button {
                padding: 12px;
                font-size: 14px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- –≠–∫—Ä–∞–Ω –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è -->
        <div id="connectScreen" class="screen active">
            <h1>üö¢ –ú–æ—Ä—Å–∫–æ–π –±–æ–π</h1>
            <div class="game-info">
                <h3>–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–≥—Ä–µ</h3>
                <input type="text" id="playerName" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è" value="–ò–≥—Ä–æ–∫">
                
                <div class="instructions">
                    <strong>–ö–∞–∫ –∏–≥—Ä–∞—Ç—å:</strong><br>
                    1. –°–æ–∑–¥–∞–π—Ç–µ –∏–≥—Ä—É –∏–ª–∏ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç–µ—Å—å –∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π<br>
                    2. –†–∞—Å—Å—Ç–∞–≤—å—Ç–µ –∫–æ—Ä–∞–±–ª–∏ –Ω–∞ –ø–æ–ª–µ<br>
                    3. –ü–æ –æ—á–µ—Ä–µ–¥–∏ —Å—Ç—Ä–µ–ª—è–π—Ç–µ –ø–æ –ø–æ–ª—é –ø—Ä–æ—Ç–∏–≤–Ω–∏–∫–∞<br>
                    4. –ü–æ–±–µ–¥–∏—Ç —Ç–æ—Ç, –∫—Ç–æ –ø–µ—Ä–≤—ã–º –ø–æ—Ç–æ–ø–∏—Ç –≤—Å–µ –∫–æ—Ä–∞–±–ª–∏!
                </div>
                
                <button id="createGameBtn">–°–æ–∑–¥–∞—Ç—å –∏–≥—Ä—É</button>
                <button id="findGamesBtn">–ù–∞–π—Ç–∏ –∏–≥—Ä—ã –≤ —Å–µ—Ç–∏</button>
                <button id="localGameBtn">–ò–≥—Ä–∞—Ç—å –Ω–∞ –æ–¥–Ω–æ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ</button>
                
                <div id="connectionStatus" class="connection-status disconnected">
                    –ù–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–æ
                </div>
            </div>
        </div>

        <!-- –≠–∫—Ä–∞–Ω —Ö–æ—Å—Ç–∞ -->
        <div id="hostScreen" class="screen">
            <h1>üéÆ –°–æ–∑–¥–∞–Ω–∏–µ –∏–≥—Ä—ã</h1>
            <div class="game-info">
                <div class="status-message" id="hostStatus">–û–∂–∏–¥–∞–Ω–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∏–≥—Ä–æ–∫–æ–≤...</div>
                <div class="qr-code">
                    <div id="qrcode"></div>
                    <p>–î—Ä—É–≥–∏–µ –∏–≥—Ä–æ–∫–∏ –º–æ–≥—É—Ç –æ—Ç—Å–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å QR-–∫–æ–¥ –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è</p>
                </div>
                <div class="player-list" id="connectedPlayers">
                    <h4>–ü–æ–¥–∫–ª—é—á–µ–Ω–Ω—ã–µ –∏–≥—Ä–æ–∫–∏:</h4>
                    <div class="player-item">–û–∂–∏–¥–∞–Ω–∏–µ –∏–≥—Ä–æ–∫–æ–≤...</div>
                </div>
                <button id="startHostGameBtn" disabled>–ù–∞—á–∞—Ç—å –∏–≥—Ä—É</button>
                <button id="backToMenuBtn">–ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é</button>
            </div>
        </div>

        <!-- –≠–∫—Ä–∞–Ω –≤—ã–±–æ—Ä–∞ –∏–≥—Ä—ã -->
        <div id="lobbyScreen" class="screen">
            <h1>üéÆ –ü–æ–∏—Å–∫ –∏–≥—Ä</h1>
            <div class="game-info">
                <h3>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, <span id="currentPlayerName"></span>!</h3>
                <button id="refreshGamesBtn">üîÑ –û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫</button>
                
                <div class="player-list" id="gamesList">
                    <h4>–î–æ—Å—Ç—É–ø–Ω—ã–µ –∏–≥—Ä—ã –≤ —Å–µ—Ç–∏:</h4>
                    <div class="player-item">–ü–æ–∏—Å–∫ –∏–≥—Ä...</div>
                </div>
                
                <button id="backToMainBtn">–ù–∞–∑–∞–¥</button>
            </div>
        </div>

        <!-- –≠–∫—Ä–∞–Ω —Ä–∞—Å—Å—Ç–∞–Ω–æ–≤–∫–∏ –∫–æ—Ä–∞–±–ª–µ–π -->
        <div id="placementScreen" class="screen">
            <h1>‚öì –†–∞—Å—Å—Ç–∞–Ω–æ–≤–∫–∞ –∫–æ—Ä–∞–±–ª–µ–π</h1>
            <div class="game-info">
                <div id="placementStatus">–†–∞—Å—Å—Ç–∞–≤—å—Ç–µ –≤–∞—à–∏ –∫–æ—Ä–∞–±–ª–∏</div>
                <div class="ship-counter">
                    –ö–æ—Ä–∞–±–ª–∏: 1x4, 2x3, 3x2, 4x1
                </div>
            </div>
            
            <div class="boards-container">
                <div class="board-section">
                    <div class="board-title">–í–∞—à–µ –ø–æ–ª–µ</div>
                    <div class="board" id="playerBoard"></div>
                </div>
            </div>
            
            <button id="autoPlaceBtn">–ê–≤—Ç–æ—Ä–∞—Å—Å—Ç–∞–Ω–æ–≤–∫–∞</button>
            <button id="readyBtn" disabled>–ì–æ—Ç–æ–≤ –∫ –±–æ—é!</button>
            <button id="cancelGameBtn">–û—Ç–º–µ–Ω–∞</button>
        </div>

        <!-- –≠–∫—Ä–∞–Ω –∏–≥—Ä—ã -->
        <div id="gameScreen" class="screen">
            <h1>üéØ –ú–æ—Ä—Å–∫–æ–π –±–æ–π</h1>
            <div class="game-info">
                <div id="gameStatus">–û–∂–∏–¥–∞–Ω–∏–µ —Ö–æ–¥–∞...</div>
                <div class="ship-counter">
                    <span>–í–∞—à–∏ –∫–æ—Ä–∞–±–ª–∏: <span id="playerShipsCount">10</span></span>
                    <span>–ö–æ—Ä–∞–±–ª–∏ –ø—Ä–æ—Ç–∏–≤–Ω–∏–∫–∞: <span id="enemyShipsCount">10</span></span>
                </div>
            </div>
            
            <div class="boards-container">
                <div class="board-section">
                    <div class="board-title">–í–∞—à–µ –ø–æ–ª–µ</div>
                    <div class="board" id="gamePlayerBoard"></div>
                </div>
                
                <div class="board-section">
                    <div class="board-title">–ü–æ–ª–µ –ø—Ä–æ—Ç–∏–≤–Ω–∏–∫–∞</div>
                    <div class="board" id="enemyBoard"></div>
                </div>
            </div>
            
            <button id="leaveGameBtn">–ü–æ–∫–∏–Ω—É—Ç—å –∏–≥—Ä—É</button>
        </div>

        <!-- –≠–∫—Ä–∞–Ω –ª–æ–∫–∞–ª—å–Ω–æ–π –∏–≥—Ä—ã -->
        <div id="localGameScreen" class="screen">
            <h1>üì± –õ–æ–∫–∞–ª—å–Ω–∞—è –∏–≥—Ä–∞</h1>
            <div class="game-info">
                <div id="localGameStatus">–ò–≥—Ä–æ–∫ 1 —Ä–∞—Å—Å—Ç–∞–≤–ª—è–µ—Ç –∫–æ—Ä–∞–±–ª–∏</div>
                <div class="ship-counter">
                    <span id="localPlayerInfo">–ò–≥—Ä–æ–∫ 1: <span id="localPlayerShips">10</span> –∫–æ—Ä–∞–±–ª–µ–π</span>
                </div>
            </div>
            
            <div class="boards-container">
                <div class="board-section">
                    <div class="board-title" id="localBoardTitle">–ü–æ–ª–µ –ò–≥—Ä–æ–∫–∞ 1</div>
                    <div class="board" id="localPlayerBoard"></div>
                </div>
            </div>
            
            <button id="localAutoPlaceBtn">–ê–≤—Ç–æ—Ä–∞—Å—Å—Ç–∞–Ω–æ–≤–∫–∞</button>
            <button id="localReadyBtn">–ì–æ—Ç–æ–≤–æ</button>
            <button id="localBackBtn">–ù–∞–∑–∞–¥</button>
        </div>
    </div>

    <script>
        class BattleshipGame {
            constructor() {
                this.socket = null;
                this.peerConnection = null;
                this.dataChannel = null;
                this.isHost = false;
                this.playerId = this.generateId();
                this.playerName = '–ò–≥—Ä–æ–∫';
                this.currentGame = null;
                this.gameState = 'menu';
                this.localGame = {
                    player1Board: null,
                    player2Board: null,
                    currentPlayer: 1,
                    phase: 'placement1'
                };
                
                this.shipSizes = [4, 3, 3, 2, 2, 2, 1, 1, 1, 1];
                
                this.initializeEventListeners();
                this.loadPlayerName();
            }
            
            initializeEventListeners() {
                // –ö–Ω–æ–ø–∫–∏ –º–µ–Ω—é
                document.getElementById('createGameBtn').addEventListener('click', () => this.createGame());
                document.getElementById('findGamesBtn').addEventListener('click', () => this.findGames());
                document.getElementById('localGameBtn').addEventListener('click', () => this.startLocalGame());
                document.getElementById('backToMenuBtn').addEventListener('click', () => this.showScreen('connectScreen'));
                document.getElementById('backToMainBtn').addEventListener('click', () => this.showScreen('connectScreen'));
                document.getElementById('cancelGameBtn').addEventListener('click', () => this.cancelGame());
                
                // –ö–Ω–æ–ø–∫–∏ –ª–æ–±–±–∏
                document.getElementById('refreshGamesBtn').addEventListener('click', () => this.refreshGames());
                document.getElementById('startHostGameBtn').addEventListener('click', () => this.startHostGame());
                
                // –ö–Ω–æ–ø–∫–∏ —Ä–∞—Å—Å—Ç–∞–Ω–æ–≤–∫–∏
                document.getElementById('autoPlaceBtn').addEventListener('click', () => this.autoPlaceShips());
                document.getElementById('readyBtn').addEventListener('click', () => this.readyForBattle());
                
                // –ö–Ω–æ–ø–∫–∏ –∏–≥—Ä—ã
                document.getElementById('leaveGameBtn').addEventListener('click', () => this.leaveGame());
                
                // –õ–æ–∫–∞–ª—å–Ω–∞—è –∏–≥—Ä–∞
                document.getElementById('localAutoPlaceBtn').addEventListener('click', () => this.localAutoPlace());
                document.getElementById('localReadyBtn').addEventListener('click', () => this.localReady());
                document.getElementById('localBackBtn').addEventListener('click', () => this.localBack());
                
                // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏–º–µ–Ω–∏
                document.getElementById('playerName').addEventListener('input', (e) => {
                    this.playerName = e.target.value;
                    localStorage.setItem('playerName', this.playerName);
                });
            }
            
            loadPlayerName() {
                const savedName = localStorage.getItem('playerName');
                if (savedName) {
                    this.playerName = savedName;
                    document.getElementById('playerName').value = savedName;
                }
            }
            
            generateId() {
                return Math.random().toString(36).substr(2, 9);
            }
            
            showScreen(screenId) {
                document.querySelectorAll('.screen').forEach(screen => {
                    screen.classList.remove('active');
                });
                document.getElementById(screenId).classList.add('active');
            }
            
            // –°–æ–∑–¥–∞–Ω–∏–µ –∏–≥—Ä—ã (–•–æ—Å—Ç)
            async createGame() {
                this.playerName = document.getElementById('playerName').value || '–ò–≥—Ä–æ–∫';
                this.isHost = true;
                
                try {
                    // –ü—ã—Ç–∞–µ–º—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å WebRTC –¥–ª—è P2P —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
                    await this.initializeWebRTC();
                    this.showScreen('hostScreen');
                    this.updateHostStatus('–û–∂–∏–¥–∞–Ω–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∏–≥—Ä–æ–∫–æ–≤...');
                    
                    // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º QR-–∫–æ–¥ —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
                    this.generateQRCode();
                    
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∏–≥—Ä—ã:', error);
                    this.updateHostStatus('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∏–≥—Ä—ã');
                }
            }
            
            // –ü–æ–∏—Å–∫ –∏–≥—Ä –≤ –ª–æ–∫–∞–ª—å–Ω–æ–π —Å–µ—Ç–∏
            async findGames() {
                this.playerName = document.getElementById('playerName').value || '–ò–≥—Ä–æ–∫';
                this.showScreen('lobbyScreen');
                document.getElementById('currentPlayerName').textContent = this.playerName;
                
                // –ò–º–∏—Ç–∞—Ü–∏—è –ø–æ–∏—Å–∫–∞ –∏–≥—Ä –≤ –ª–æ–∫–∞–ª—å–Ω–æ–π —Å–µ—Ç–∏
                this.simulateNetworkDiscovery();
            }
            
            simulateNetworkDiscovery() {
                const gamesList = document.getElementById('gamesList');
                gamesList.innerHTML = '<h4>–î–æ—Å—Ç—É–ø–Ω—ã–µ –∏–≥—Ä—ã –≤ —Å–µ—Ç–∏:</h4>';
                
                // –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –∑–¥–µ—Å—å –±—ã–ª –±—ã –ø–æ–∏—Å–∫ –ø–æ —Å–µ—Ç–∏
                // –°–µ–π—á–∞—Å –ø—Ä–æ—Å—Ç–æ –ø–æ–∫–∞–∂–µ–º –ø—Ä–∏–º–µ—Ä –∏–≥—Ä—ã
                const gameItem = document.createElement('div');
                gameItem.className = 'player-item';
                gameItem.innerHTML = `
                    <strong>–ò–≥—Ä–∞ ${this.generateId().substr(0, 5)}</strong>
                    <br>–•–æ—Å—Ç: –î—Ä—É–≥–æ–π –∏–≥—Ä–æ–∫
                    <br>–ò–≥—Ä–æ–∫–æ–≤: 1/2
                `;
                gameItem.addEventListener('click', () => {
                    this.joinGame('demo-game');
                });
                
                gamesList.appendChild(gameItem);
                
                // –ü–æ–∫–∞–∂–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ, –µ—Å–ª–∏ –∏–≥—Ä –Ω–µ—Ç
                setTimeout(() => {
                    if (gamesList.children.length === 1) {
                        const noGames = document.createElement('div');
                        noGames.className = 'player-item';
                        noGames.textContent = '–ò–≥—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã. –°–æ–∑–¥–∞–π—Ç–µ —Å–≤–æ—é –∏–≥—Ä—É!';
                        noGames.style.cursor = 'default';
                        gamesList.appendChild(noGames);
                    }
                }, 2000);
            }
            
            joinGame(gameId) {
                this.showScreen('placementScreen');
                this.initializePlacementBoard();
                document.getElementById('placementStatus').textContent = '–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–≥—Ä–µ...';
                
                // –ò–º–∏—Ç–∞—Ü–∏—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
                setTimeout(() => {
                    document.getElementById('placementStatus').textContent = '–†–∞—Å—Å—Ç–∞–≤—å—Ç–µ –≤–∞—à–∏ –∫–æ—Ä–∞–±–ª–∏';
                    document.getElementById('readyBtn').disabled = false;
                }, 1500);
            }
            
            // –õ–æ–∫–∞–ª—å–Ω–∞—è –∏–≥—Ä–∞ –Ω–∞ –æ–¥–Ω–æ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ
            startLocalGame() {
                this.playerName = document.getElementById('playerName').value || '–ò–≥—Ä–æ–∫';
                this.showScreen('localGameScreen');
                this.localGame.phase = 'placement1';
                this.localGame.player1Board = this.createEmptyBoard();
                this.localGame.player2Board = this.createEmptyBoard();
                this.initializeLocalGame();
            }
            
            initializeLocalGame() {
                const board = this.localGame.phase === 'placement1' ? 
                    this.localGame.player1Board : this.localGame.player2Board;
                
                this.renderBoard('localPlayerBoard', board, false);
                
                const playerNum = this.localGame.phase === 'placement1' ? 1 : 2;
                document.getElementById('localBoardTitle').textContent = `–ü–æ–ª–µ –ò–≥—Ä–æ–∫–∞ ${playerNum}`;
                document.getElementById('localGameStatus').textContent = `–ò–≥—Ä–æ–∫ ${playerNum} —Ä–∞—Å—Å—Ç–∞–≤–ª—è–µ—Ç –∫–æ—Ä–∞–±–ª–∏`;
                document.getElementById('localPlayerInfo').textContent = `–ò–≥—Ä–æ–∫ ${playerNum}: 10 –∫–æ—Ä–∞–±–ª–µ–π`;
                
                document.getElementById('localReadyBtn').disabled = false;
            }
            
            localAutoPlace() {
                const board = this.localGame.phase === 'placement1' ? 
                    this.localGame.player1Board : this.localGame.player2Board;
                
                const newBoard = this.generateRandomBoard();
                if (this.localGame.phase === 'placement1') {
                    this.localGame.player1Board = newBoard;
                } else {
                    this.localGame.player2Board = newBoard;
                }
                
                this.renderBoard('localPlayerBoard', newBoard, false);
            }
            
            localReady() {
                if (this.localGame.phase === 'placement1') {
                    this.localGame.phase = 'placement2';
                    this.initializeLocalGame();
                } else {
                    this.localGame.phase = 'battle';
                    this.startLocalBattle();
                }
            }
            
            startLocalBattle() {
                this.showScreen('gameScreen');
                this.localGame.currentPlayer = 1;
                
                this.renderBoard('gamePlayerBoard', this.localGame.player1Board, false);
                this.renderBoard('enemyBoard', this.maskEnemyBoard(this.localGame.player2Board), true);
                
                document.getElementById('gameStatus').textContent = '–•–æ–¥ –ò–≥—Ä–æ–∫–∞ 1';
                this.updateLocalShipCounts();
            }
            
            handleLocalMove(row, col) {
                if (this.localGame.phase !== 'battle') return;
                
                const targetBoard = this.localGame.currentPlayer === 1 ? 
                    this.localGame.player2Board : this.localGame.player1Board;
                
                if (targetBoard[row][col] >= 2) return; // –£–∂–µ —Å—Ç—Ä–µ–ª—è–ª–∏
                
                const hit = targetBoard[row][col] === 1;
                targetBoard[row][col] = hit ? 2 : 3;
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
                if (this.localGame.currentPlayer === 1) {
                    this.renderBoard('enemyBoard', this.maskEnemyBoard(this.localGame.player2Board), true);
                } else {
                    this.renderBoard('gamePlayerBoard', this.localGame.player1Board, false);
                }
                
                if (hit) {
                    document.getElementById('gameStatus').textContent = `–ò–≥—Ä–æ–∫ ${this.localGame.currentPlayer} –ø–æ–ø–∞–ª!`;
                    
                    if (this.checkWin(targetBoard)) {
                        document.getElementById('gameStatus').textContent = 
                            `üéâ –ò–≥—Ä–æ–∫ ${this.localGame.currentPlayer} –ø–æ–±–µ–¥–∏–ª!`;
                        return;
                    }
                    
                    // –ü—Ä–∏ –ø–æ–ø–∞–¥–∞–Ω–∏–∏ —Ö–æ–¥ –æ—Å—Ç–∞–µ—Ç—Å—è —É —Ç–æ–≥–æ –∂–µ –∏–≥—Ä–æ–∫–∞
                    setTimeout(() => {
                        document.getElementById('gameStatus').textContent = 
                            `–ò–≥—Ä–æ–∫ ${this.localGame.currentPlayer} –ø–æ–ø–∞–¥–∞–µ—Ç –µ—â–µ —Ä–∞–∑!`;
                    }, 1000);
                } else {
                    document.getElementById('gameStatus').textContent = `–ò–≥—Ä–æ–∫ ${this.localGame.currentPlayer} –ø—Ä–æ–º–∞—Ö–Ω—É–ª—Å—è`;
                    // –°–º–µ–Ω–∞ —Ö–æ–¥–∞
                    this.localGame.currentPlayer = this.localGame.currentPlayer === 1 ? 2 : 1;
                    setTimeout(() => {
                        document.getElementById('gameStatus').textContent = 
                            `–•–æ–¥ –ò–≥—Ä–æ–∫–∞ ${this.localGame.currentPlayer}`;
                    }, 1500);
                }
                
                this.updateLocalShipCounts();
            }
            
            updateLocalShipCounts() {
                const player1Ships = this.countRemainingShips(this.localGame.player1Board);
                const player2Ships = this.countRemainingShips(this.localGame.player2Board);
                
                document.getElementById('playerShipsCount').textContent = player1Ships;
                document.getElementById('enemyShipsCount').textContent = player2Ships;
            }
            
            localBack() {
                if (this.localGame.phase === 'placement1') {
                    this.showScreen('connectScreen');
                } else if (this.localGame.phase === 'placement2') {
                    this.localGame.phase = 'placement1';
                    this.initializeLocalGame();
                } else {
                    this.showScreen('connectScreen');
                }
            }
            
            // WebRTC –∏ —Å–µ—Ç–µ–≤–æ–µ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ (—É–ø—Ä–æ—â–µ–Ω–Ω–æ–µ)
            async initializeWebRTC() {
                // –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –∑–¥–µ—Å—å –±—ã–ª–∞ –±—ã –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ WebRTC
                console.log('WebRTC –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è...');
            }
            
            generateQRCode() {
                const qrContainer = document.getElementById('qrcode');
                qrContainer.innerHTML = `
                    <div style="background: white; padding: 20px; display: inline-block; border-radius: 10px;">
                        <div style="width: 200px; height: 200px; background: #f0f0f0; display: flex; align-items: center; justify-content: center; border-radius: 5px;">
                            <div style="text-align: center; color: #333;">
                                <div style="font-size: 14px; margin-bottom: 10px;">QR-–∫–æ–¥</div>
                                <div style="font-size: 12px;">–ò–≥—Ä–∞: ${this.playerName}</div>
                                <div style="font-size: 10px; margin-top: 5px;">(–§—É–Ω–∫—Ü–∏—è –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ)</div>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            updateHostStatus(message) {
                document.getElementById('hostStatus').textContent = message;
            }
            
            refreshGames() {
                this.simulateNetworkDiscovery();
            }
            
            startHostGame() {
                this.showScreen('placementScreen');
                this.initializePlacementBoard();
            }
            
            cancelGame() {
                this.showScreen('connectScreen');
            }
            
            // –†–∞–±–æ—Ç–∞ —Å –∏–≥—Ä–æ–≤—ã–º–∏ –¥–æ—Å–∫–∞–º–∏
            createEmptyBoard() {
                return Array(10).fill().map(() => Array(10).fill(0));
            }
            
            initializePlacementBoard() {
                const board = this.createEmptyBoard();
                this.renderBoard('playerBoard', board, false);
                document.getElementById('readyBtn').disabled = false;
            }
            
            autoPlaceShips() {
                const board = this.generateRandomBoard();
                this.renderBoard('playerBoard', board, false);
            }
            
            generateRandomBoard() {
                const board = this.createEmptyBoard();
                
                for (const size of this.shipSizes) {
                    let placed = false;
                    let attempts = 0;
                    
                    while (!placed && attempts < 100) {
                        const horizontal = Math.random() < 0.5;
                        const row = Math.floor(Math.random() * 10);
                        const col = Math.floor(Math.random() * 10);
                        
                        if (this.canPlaceShip(board, row, col, size, horizontal)) {
                            this.placeShip(board, row, col, size, horizontal);
                            placed = true;
                        }
                        attempts++;
                    }
                }
                return board;
            }
            
            canPlaceShip(board, row, col, size, horizontal) {
                for (let i = 0; i < size; i++) {
                    const r = horizontal ? row : row + i;
                    const c = horizontal ? col + i : col;
                    
                    if (r >= 10 || c >= 10) return false;
                    if (board[r][c] !== 0) return false;
                    
                    // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å–µ–¥–Ω–∏—Ö –∫–ª–µ—Ç–æ–∫
                    for (let dr = -1; dr <= 1; dr++) {
                        for (let dc = -1; dc <= 1; dc++) {
                            const nr = r + dr, nc = c + dc;
                            if (nr >= 0 && nr < 10 && nc >= 0 && nc < 10 && board[nr][nc] !== 0) {
                                return false;
                            }
                        }
                    }
                }
                return true;
            }
            
            placeShip(board, row, col, size, horizontal) {
                for (let i = 0; i < size; i++) {
                    const r = horizontal ? row : row + i;
                    const c = horizontal ? col + i : col;
                    board[r][c] = 1;
                }
            }
            
            renderBoard(boardId, boardData, isEnemy) {
                const board = document.getElementById(boardId);
                board.innerHTML = '';
                
                for (let i = 0; i < 10; i++) {
                    for (let j = 0; j < 10; j++) {
                        const cell = document.createElement('div');
                        cell.className = 'cell';
                        cell.dataset.row = i;
                        cell.dataset.col = j;
                        
                        if (!isEnemy && boardData[i][j] === 1) {
                            cell.classList.add('ship');
                        } else if (boardData[i][j] === 2) {
                            cell.classList.add('hit');
                        } else if (boardData[i][j] === 3) {
                            cell.classList.add('miss');
                        }
                        
                        if (isEnemy && boardData[i][j] === 0) {
                            cell.addEventListener('click', () => this.handleEnemyCellClick(i, j));
                        } else if (boardId === 'localPlayerBoard' && this.localGame.phase.includes('placement')) {
                            cell.addEventListener('click', () => this.handleLocalPlacementClick(i, j));
                        }
                        
                        board.appendChild(cell);
                    }
                }
            }
            
            handleLocalPlacementClick(row, col) {
                const board = this.localGame.phase === 'placement1' ? 
                    this.localGame.player1Board : this.localGame.player2Board;
                
                if (board[row][col] === 0) {
                    board[row][col] = 1;
                } else {
                    board[row][col] = 0;
                }
                
                this.renderBoard('localPlayerBoard', board, false);
            }
            
            handleEnemyCellClick(row, col) {
                if (this.localGame.phase === 'battle') {
                    this.handleLocalMove(row, col);
                }
            }
            
            maskEnemyBoard(board) {
                return board.map(row => row.map(cell => {
                    return cell === 1 ? 0 : cell;
                }));
            }
            
            countRemainingShips(board) {
                return board.flat().filter(cell => cell === 1).length;
            }
            
            checkWin(board) {
                return !board.some(row => row.includes(1));
            }
            
            readyForBattle() {
                // –í —Å–µ—Ç–µ–≤–æ–π –∏–≥—Ä–µ –∑–¥–µ—Å—å –±—ã–ª–∞ –±—ã –æ—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–∞ —Å–µ—Ä–≤–µ—Ä
                this.showScreen('gameScreen');
                document.getElementById('gameStatus').textContent = '–û–∂–∏–¥–∞–Ω–∏–µ –Ω–∞—á–∞–ª–∞ –∏–≥—Ä—ã...';
                
                // –ò–º–∏—Ç–∞—Ü–∏—è –Ω–∞—á–∞–ª–∞ —Å–µ—Ç–µ–≤–æ–π –∏–≥—Ä—ã
                setTimeout(() => {
                    const playerBoard = this.generateRandomBoard();
                    const enemyBoard = this.generateRandomBoard();
                    
                    this.renderBoard('gamePlayerBoard', playerBoard, false);
                    this.renderBoard('enemyBoard', this.maskEnemyBoard(enemyBoard), true);
                    
                    document.getElementById('gameStatus').textContent = '–ò–≥—Ä–∞ –Ω–∞—á–∞–ª–∞—Å—å! –í–∞—à —Ö–æ–¥';
                }, 2000);
            }
            
            leaveGame() {
                this.showScreen('connectScreen');
            }
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏–≥—Ä—ã –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        document.addEventListener('DOMContentLoaded', () => {
            window.game = new BattleshipGame();
        });
        
        // PWA —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/sw.js').catch(console.error);
        }
        
        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–∞ –≥–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É —É—Å—Ç–∞–Ω–æ–≤–∫–∏
            setTimeout(() => {
                if (confirm('–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ "–ú–æ—Ä—Å–∫–æ–π –±–æ–π" –Ω–∞ –≥–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω?')) {
                    deferredPrompt.prompt();
                    deferredPrompt.userChoice.then((choiceResult) => {
                        if (choiceResult.outcome === 'accepted') {
                            console.log('–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ');
                        }
                        deferredPrompt = null;
                    });
                }
            }, 3000);
        });
    </script>
</body>
</html>
